{% extends "base.html" %}

{% block title %}Image Library - {{ config.NAME }}{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2><i class="fas fa-images"></i> Image Library</h2>
        <p>Browse and search images uploaded to the wiki CDN.</p>
    </div>
    <p>Copy the link of the Image you want to show, then wrap it inside of a </p>
    <form action="/images" method="get" class="search-form" style="margin: 10px 0 20px; display: flex; gap: 8px;">
        <input type="text" id="image-search" name="q" placeholder="Search images by filename..." value="{{ query or '' }}" style="flex: 1;" />
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Search</button>
        <a href="/images" class="btn btn-secondary"><i class="fas fa-times"></i> Clear</a>
    </form>

    {% if images and images|length > 0 %}
    <div class="image-grid" id="image-grid">
        {% for img in images %}
        <div class="image-card" data-name="{{ img.filename|lower }}">
            <div class="image-thumb">
                <img src="{{ img.url }}" alt="{{ img.filename }}">
            </div>
            <div class="image-meta">
                <div class="image-name" title="{{ img.filename }}">{{ img.filename }}</div>
                <div class="image-actions">
                    <a href="{{ img.url }}" target="_blank" class="btn btn-small"><i class="fas fa-external-link-alt"></i> Open</a>
                    {% if user and user.is_admin %}
                    <button type="button" class="btn btn-small btn-danger delete-image-btn" data-filename="{{ img.filename }}" data-url="{{ img.url }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">No images found{% if query %} for "{{ query }}"{% endif %}.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
}
.image-card {
    background: var(--primary-white);
    border: 1px solid var(--light-gray);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.image-thumb {
    background: var(--secondary-white);
    display: flex;
    align-items: center;
    justify-content: center;
    height: 150px;
    overflow: hidden;
}
.image-thumb img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.image-meta {
    padding: 10px;
}
.image-name {
    font-size: 0.9rem;
    color: var(--darker-gray);
    margin-bottom: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.image-actions {
    display: flex;
    gap: 8px;
}
</style>
<script nonce="{{ request.state.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('image-search');
    const grid = document.getElementById('image-grid');
    const copyButtons = document.querySelectorAll('.copy-btn');

    // Lightweight client-side filtering without roundtrip
    if (input && grid) {
        input.addEventListener('input', function () {
            const q = (input.value || '').toLowerCase();
            const cards = grid.querySelectorAll('.image-card');
            cards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                card.style.display = name.includes(q) ? '' : 'none';
            });
        });
    }

    // Copy URL to clipboard
    copyButtons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const url = btn.getAttribute('data-url');
            if (!url) return;
            navigator.clipboard.writeText(url).then(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> Copy URL', 1200);
            }).catch(() => {
                alert('Failed to copy URL');
            });
        });
    });

    // Delete image functionality
    const deleteButtons = document.querySelectorAll('.delete-image-btn');
    
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const filename = btn.getAttribute('data-filename');
            const url = btn.getAttribute('data-url');

            if (confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
                fetch(`/api/images/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        // Remove the image card from the UI
                        const card = btn.closest('.image-card');
                        if (card) {
                            card.style.transition = 'opacity 0.3s, transform 0.3s';
                            card.style.opacity = '0';
                            card.style.transform = 'scale(0.8)';
                            setTimeout(() => card.remove(), 300);
                        }
                        alert(`Image "${filename}" has been deleted successfully.`);
                    } else if (response.status === 403) {
                        alert('You do not have permission to delete this image.');
                    } else if (response.status === 404) {
                        alert('Image not found. It may have already been deleted.');
                    } else {
                        return response.json().then(err => {
                            throw new Error(err.detail || `Failed to delete image: ${response.status}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                    alert(`Failed to delete image: ${error.message}`);
                });
            }
        });
    });
});
</script>
{% endblock %}
