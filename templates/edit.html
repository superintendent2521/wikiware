{% extends "base.html" %}

{% block title %}Edit {{ title }} - WikiWare{% endblock %}

{% block content %}
<div class="container">
    {% set is_user = is_user_page|default(False) %}
    {% if is_user %}
        {% set edit_action = '/user/' ~ title ~ '/edit' %}
        {% set view_path = '/user/' ~ title %}
    {% else %}
        {% set edit_action = '/edit/' ~ title %}
        {% set view_path = '/page/' ~ title %}
    {% endif %}
    {% set branch_value = branch|default('main') %}
    {% set is_main_branch = branch_value == 'main' %}
    {% set delete_action = ('/delete/' ~ title) if is_main_branch else ('/delete-branch/' ~ title) %}
    {% set delete_label = 'Delete Page' if is_main_branch else 'Delete Branch Page' %}
    {% set delete_confirm = 'Are you sure you want to delete ' ~ ('this page' if is_main_branch else 'this branch page') ~ '? This action cannot be undone.' %}
    <link rel="stylesheet" href="{{ url_for('static', path='editor.css') }}">
    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="modal" style="display: none;">
        <div class="modal-content image-modal">
            <span class="close" aria-label="Close">&times;</span>
            <div class="image-modal-header">
                <h3 class="image-modal-title">Images</h3>
                <div class="image-modal-tabs">
                    <button type="button" class="btn btn-secondary btn-small image-modal-tab" data-tab="library">Browse Library</button>
                </div>
            </div>
            <div id="imageModalUploadSection" class="image-modal-section">
                <form id="imageUploadForm">
                    <div class="form-group">
                        <label for="imageFile">Select Image:</label>
                        <input type="file" id="imageFile" name="image" accept="image/*">
                    </div>
                    <div class="form-actions modal-actions">
                        <button type="submit" class="btn btn-primary">Upload Image</button>
                        <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
                    </div>
                </form>
                <div id="uploadStatus"></div>
            </div>
            <div id="imageModalLibrarySection" class="image-modal-section" hidden>
                <div class="image-library-controls">
                    <input type="search" id="imageLibrarySearch" class="form-control" placeholder="Search images by filename">
                    <button type="button" class="btn btn-secondary btn-small" id="refreshImageLibraryBtn">Refresh</button>
                </div>
                <div id="imageLibraryStatus" class="image-library-status"></div>
                <div id="imageLibraryList" class="image-library-grid" role="list"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="backToUploadBtn">Back to Upload</button>
                    <button type="button" class="btn btn-secondary" id="cancelLibrary">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% if request.query_params.get('restored') %}
    <div class="alert alert-success">
        Page restored successfully.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="edit-header">
        <h2>Editing: {{ title }}</h2>
    <div class="edit-actions">
            <div class="branch-selector">
                <button type="button" class="branch-button" aria-haspopup="true" aria-expanded="false">
                    <span class="branch-icon"><i class="fas fa-code-branch"></i></span>
                    <span class="branch-name">{{ branch_value }}</span>
                    <span class="dropdown-icon"><i class="fas fa-chevron-down"></i></span>
                </button>
                <div class="branch-dropdown" role="menu">
                    <div class="branch-option {% if branch_value == 'main' %}current{% endif %}" data-branch="main">
                        <span class="branch-icon"><i class="fas fa-code-branch"></i></span>
                        <span class="branch-name">main</span>
                    </div>
                    {% if branches %}
                    {% for b in branches %}
                    {% if b != 'main' %}
                    <div class="branch-option {% if branch_value == b %}current{% endif %}" data-branch="{{ b }}">
                        <span class="branch-icon"><i class="fas fa-code-branch"></i></span>
                        <span class="branch-name">{{ b }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <a href="{{ view_path }}?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-eye"></i> View Page</a>
            <a href="/history/{{ title }}?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-history"></i> View History</a>
            {% if user and user.is_admin %}
            <form action="{{ delete_action }}" method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="branch" value="{{ branch_value }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('{{ delete_confirm }}')"><i class="fas fa-trash"></i> {{ delete_label }}</button>
            </form>
            {% endif %}
            <a href="/?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-home"></i> Back to Home</a>
        </div>
    </div>

    {% if branch %}
    <div class="branch-info">
        <p><strong>Current Branch:</strong> {{ branch }}</p>
    </div>
    {% endif %}

    <div class="branch-info">
        <details>
            <summary>Branch Management</summary>
            <form action="/branches/{{ title }}/create" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="branch" value="{{ branch_value }}">
                <div class="form-group">
                    <label for="branch_name">New Branch Name:</label>
                    <input type="text" id="branch_name" name="branch_name" required>
                </div>
                <div class="form-group">
                    <label for="source_branch">Source Branch:</label>
                    <select name="source_branch" id="source_branch">
                        <option value="main">main</option>
                        {% if branches %}
                        {% for b in branches %}
                        {% if b != 'main' %}
                        <option value="{{ b }}" {% if b == branch_value %}selected{% endif %}>{{ b }}</option>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create Branch</button>
            </form>
        </details>
    </div>



    <div class="edit-form-container">
        <form id="editForm" action="{{ edit_action }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="branch" value="{{ branch_value }}">
            <div class="form-group">
                <label>Author:</label>
                <input type="text" value="{{ user.username }}" readonly>
                <input type="hidden" name="author" value="{{ user.username }}">
            </div>

            <div class="form-group">
                <label for="content">Content (Visual editor with Markdown save):</label>
                <div class="editor-toolbar" id="wiki-editor-toolbar">
                    <button type="button" data-cmd="formatBlock" data-value="P" class="btn btn-secondary btn-small" title="Normal Text"><i class="fas fa-paragraph"></i> Normal</button>
                    <button type="button" data-cmd="formatBlock" data-value="H1" class="btn btn-secondary btn-small" title="Heading 1"><i class="fas fa-heading"></i> H1</button>
                    <button type="button" data-cmd="formatBlock" data-value="H2" class="btn btn-secondary btn-small" title="Heading 2">H2</button>
                    <button type="button" data-cmd="formatBlock" data-value="H3" class="btn btn-secondary btn-small" title="Heading 3">H3</button>
                    <span class="sep"></span>
                    <button type="button" data-cmd="bold" class="btn btn-secondary btn-small" title="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" data-cmd="italic" class="btn btn-secondary btn-small" title="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" data-cmd="underline" class="btn btn-secondary btn-small" title="Underline"><i class="fas fa-underline"></i></button>
                    <span class="sep"></span>
                    <button type="button" data-cmd="insertUnorderedList" class="btn btn-secondary btn-small" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
                    <button type="button" data-cmd="insertOrderedList" class="btn btn-secondary btn-small" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button type="button" id="createLinkBtn" class="btn btn-secondary btn-small" title="Insert Link"><i class="fas fa-link"></i></button>
                    <span class="sep"></span>
                    <button type="button" id="insertTableBtn" class="btn btn-secondary btn-small" title="Insert Table"><i class="fas fa-table"></i> Table</button>
                    <div class="table-tools">
                        <button type="button" id="addRowBtn" class="btn btn-secondary btn-small" title="Add Row">+ Row</button>
                        <button type="button" id="addColBtn" class="btn btn-secondary btn-small" title="Add Column">+ Col</button>
                        <button type="button" id="delRowBtn" class="btn btn-secondary btn-small" title="Delete Row">- Row</button>
                        <button type="button" id="delColBtn" class="btn btn-secondary btn-small" title="Delete Column">- Col</button>
                    </div>
                    <span class="sep"></span>
                    <button type="button" id="insertImageBtn" class="btn btn-secondary btn-small" title="Insert Image">
                        <i class="fas fa-image"></i> Image
                    </button>
                </div>
                <div id="visual-editor" class="visual-editor" contenteditable="true"></div>
                <textarea id="content" name="content" rows="20" style="display:none;">{{ content }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Page</button>
                <a href="{{ view_path }}?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</a>
            </div>
        </form>
    </div>

    <div class="markdown-help">
        <h3>Markdown Help</h3>
        <ul>
            <li><code># Header</code> - Large header</li>
            <li><code>## Subheader</code> - Smaller header</li>
            <li><code>**bold**</code> - Bold text</li>
            <li><code>*italic*</code> - Italic text</li>
            <li><code>[link](url)</code> - Link To outside resource</li>
            <li><code>[[ Page:Branch ]]</code> - Link to another wiki page</li>
            <li><code>`code`</code> - Inline code</li>
            <li><code>```code block```</code> - Code block</li>
            <li><code>![alt text](image-url)</code> - Image (use Insert Image button to upload)</li>
            <a href="/help/index.html" target="_blank">View global variables</a>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='editor.js') }}"></script>
<script nonce="{{ request.state.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize client-side visual editor (M1 + M2)
        if (window.WikiEditor && typeof window.WikiEditor.init === 'function') {
            window.WikiEditor.init({
                textareaSelector: '#content',
                editorSelector: '#visual-editor',
                toolbarSelector: '#wiki-editor-toolbar',
                formSelector: '#editForm',
                initialMarkdown: document.getElementById('content').value || ''
            });
        }

        // Image modal elements
        const modal = document.getElementById('imageUploadModal');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const closeBtn = document.querySelector('#imageUploadModal .close');
        const cancelUpload = document.getElementById('cancelUpload');
        const cancelLibrary = document.getElementById('cancelLibrary');
        const backToUploadBtn = document.getElementById('backToUploadBtn');
        const imageUploadForm = document.getElementById('imageUploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const contentTextarea = document.getElementById('content');
        const imageModalUploadSection = document.getElementById('imageModalUploadSection');
        const imageModalLibrarySection = document.getElementById('imageModalLibrarySection');
        const tabButtons = Array.from(document.querySelectorAll('.image-modal-tab'));
        const imageLibrarySearch = document.getElementById('imageLibrarySearch');
        const refreshImageLibraryBtn = document.getElementById('refreshImageLibraryBtn');
        const imageLibraryList = document.getElementById('imageLibraryList');
        const imageLibraryStatus = document.getElementById('imageLibraryStatus');

        let imageLibraryItems = [];
        let imageLibraryLoaded = false;

        function showSection(section) {
            const target = section === 'library' ? 'library' : 'upload';
            const showLibrary = target === 'library';
            if (imageModalUploadSection) imageModalUploadSection.hidden = showLibrary;
            if (imageModalLibrarySection) imageModalLibrarySection.hidden = !showLibrary;
            tabButtons.forEach((btn) => {
                const btnTarget = btn.getAttribute('data-tab');
                btn.classList.toggle('active', btnTarget === target);
            });
            if (showLibrary) {
                loadImageLibrary();
                if (imageLibrarySearch) {
                    requestAnimationFrame(() => {
                        try {
                            imageLibrarySearch.focus({ preventScroll: true });
                        } catch (_) {
                            imageLibrarySearch.focus();
                        }
                    });
                }
            }
        }

        function resetLibraryState() {
            if (imageLibrarySearch) imageLibrarySearch.value = '';
            if (imageLibraryStatus) imageLibraryStatus.innerHTML = '';
            if (imageLibraryList) imageLibraryList.innerHTML = '';
        }

        function hideModal() {
            if (!modal) return;
            modal.style.display = 'none';
            showSection('upload');
            if (imageUploadForm) imageUploadForm.reset();
            if (uploadStatus) uploadStatus.innerHTML = '';
            resetLibraryState();
        }

        function showModal(section = 'upload') {
            if (!modal) return;
            if (window.WikiEditor && typeof window.WikiEditor.captureSelection === 'function') {
                window.WikiEditor.captureSelection();
            }
            showSection(section);
            modal.style.display = 'block';
        }

        function insertImageIntoEditor(src, filename) {
            if (!src) return;
            if (window.WikiEditor) {
                if (typeof window.WikiEditor.restoreSelection === 'function') {
                    window.WikiEditor.restoreSelection();
                }
                if (typeof window.WikiEditor.insertImage === 'function') {
                    window.WikiEditor.insertImage({ src, alt: filename || '' });
                    return;
                }
            }
            if (contentTextarea) {
                const imageMarkdown = '![' + (filename || '') + '](' + src + ')';
                const startPos = contentTextarea.selectionStart || 0;
                const endPos = contentTextarea.selectionEnd || 0;
                const content = contentTextarea.value || '';
                contentTextarea.value = content.substring(0, startPos) + imageMarkdown + content.substring(endPos);
            }
        }

        function renderLibrary(filterTerm) {
            if (!imageLibraryList) return;
            const inputValue = filterTerm !== undefined ? filterTerm : (imageLibrarySearch ? imageLibrarySearch.value : '');
            const term = inputValue.trim().toLowerCase();
            const filtered = term
                ? imageLibraryItems.filter((item) => (item.filename || '').toLowerCase().includes(term))
                : imageLibraryItems.slice();
            imageLibraryList.innerHTML = '';
            if (!filtered.length) {
                if (imageLibraryStatus) {
                    imageLibraryStatus.innerHTML = '<div class="alert alert-info">No images found.</div>';
                }
                return;
            }
            if (imageLibraryStatus) imageLibraryStatus.innerHTML = '';
            filtered.forEach((item) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'image-library-item';
                const thumb = document.createElement('img');
                thumb.src = item.url;
                thumb.alt = item.filename || '';
                thumb.loading = 'lazy';
                const label = document.createElement('span');
                label.textContent = item.filename || '';
                button.appendChild(thumb);
                button.appendChild(label);
                button.addEventListener('click', () => {
                    insertImageIntoEditor(item.url, item.filename);
                    hideModal();
                });
                imageLibraryList.appendChild(button);
            });
        }

        async function loadImageLibrary(force = false) {
            if (!imageLibraryList) return;
            if (imageLibraryLoaded && !force) {
                renderLibrary();
                return;
            }
            if (imageLibraryStatus) {
                imageLibraryStatus.innerHTML = '<div class="alert alert-info">Loading images...</div>';
            }
            imageLibraryList.innerHTML = '';
            try {
                const response = await fetch('/api/images', { credentials: 'same-origin' });
                if (!response.ok) {
                    throw new Error('Unable to fetch images.');
                }
                const data = await response.json();
                imageLibraryItems = Array.isArray(data.items) ? data.items : [];
                imageLibraryLoaded = true;
                renderLibrary();
            } catch (error) {
                if (imageLibraryStatus) {
                    imageLibraryStatus.innerHTML = '<div class="alert alert-error">Error loading images: ' + error.message + '</div>';
                }
            }
        }

        if (insertImageBtn) {
            insertImageBtn.addEventListener('click', () => showModal('upload'));
        }
        if (closeBtn) closeBtn.addEventListener('click', hideModal);
        if (cancelUpload) cancelUpload.addEventListener('click', hideModal);
        if (cancelLibrary) cancelLibrary.addEventListener('click', hideModal);
        if (backToUploadBtn) backToUploadBtn.addEventListener('click', () => showSection('upload'));
        tabButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-tab') || 'upload';
                showSection(target);
            });
        });
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideModal();
            }
        });
        if (refreshImageLibraryBtn) {
            refreshImageLibraryBtn.addEventListener('click', () => loadImageLibrary(true));
        }
        if (imageLibrarySearch) {
            imageLibrarySearch.addEventListener('input', () => {
                renderLibrary(imageLibrarySearch.value || '');
            });
        }

        if (imageUploadForm) {
            imageUploadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('imageFile');
                const file = fileInput ? fileInput.files[0] : null;
                if (!file) {
                    if (uploadStatus) {
                        uploadStatus.innerHTML = '<div class="alert alert-error">Please select an image file.</div>';
                    }
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                let csrfToken = '';
                try {
                    const csrfInput = document.querySelector('input[name="csrf_token"]');
                    if (csrfInput && csrfInput.value) {
                        csrfToken = csrfInput.value;
                        formData.append('csrf_token', csrfToken);
                    }
                } catch (_) { /* no-op */ }

                if (uploadStatus) {
                    uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';
                }

                fetch('/upload-image', {
                    method: 'POST',
                    headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {},
                    credentials: 'same-origin',
                    body: formData
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.error) {
                            if (uploadStatus) {
                                uploadStatus.innerHTML = '<div class="alert alert-error">' + data.error + '</div>';
                            }
                            return;
                        }
                        insertImageIntoEditor(data.url, data.filename);
                        imageLibraryLoaded = false;
                        hideModal();
                    })
                    .catch((error) => {
                        if (uploadStatus) {
                            uploadStatus.innerHTML = '<div class="alert alert-error">Error uploading image: ' + error.message + '</div>';
                        }
                    });
            });
        }
    });
</script>
{% endblock %}
