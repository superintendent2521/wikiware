{% extends "base.html" %}

{% block title %}Edit {{ title }} - WikiWare{% endblock %}

{% block content %}
<div class="container">
    {% set is_user = is_user_page|default(False) %}
    {% if is_user %}
        {% set edit_action = '/user/' ~ title ~ '/edit' %}
        {% set view_path = '/user/' ~ title %}
    {% else %}
        {% set edit_action = '/edit/' ~ title %}
        {% set view_path = '/page/' ~ title %}
    {% endif %}
    {% set branch_value = branch|default('main') %}
    <link rel="stylesheet" href="{{ url_for('static', path='editor.css') }}">
    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Upload Image</h3>
            <form id="imageUploadForm">
                <div class="form-group">
                    <label for="imageFile">Select Image:</label>
                    <input type="file" id="imageFile" name="image" accept="image/*">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Upload Image</button>
                    <a href="/images" target="_blank" class="btn btn-secondary">Browse Images</a>
                    <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
                </div>
            </form>
            <div id="uploadStatus"></div>
        </div>
    </div>
    {% if request.query_params.get('restored') %}
    <div class="alert alert-success">
        Page restored successfully.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="edit-header">
        <h2>Editing: {{ title }}</h2>
    <div class="edit-actions">
            <a href="{{ view_path }}?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-eye"></i> View Page</a>
            <a href="/history/{{ title }}?branch={{ branch or 'main' }}" class="btn btn-secondary"><i class="fas fa-history"></i> View History</a>
            {% if user and user.is_admin %}
            <form action="/delete/{{ title }}" method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="branch" value="{{ branch or 'main' }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this page? This action cannot be undone.')"><i class="fas fa-trash"></i> Delete Page</button>
            </form>
            {% endif %}
            <a href="/?branch={{ branch or 'main' }}" class="btn btn-secondary"><i class="fas fa-home"></i> Back to Home</a>
        </div>
    </div>

    {% if branch %}
    <div class="branch-info">
        <p><strong>Current Branch:</strong> {{ branch }}</p>
    </div>
    {% endif %}

    <div class="branch-info">
        <details>
            <summary>Branch Management</summary>
            <form action="/branches/{{ title }}/create" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="branch" value="{{ branch or 'main' }}">
                <div class="form-group">
                    <label for="branch_name">New Branch Name:</label>
                    <input type="text" id="branch_name" name="branch_name" required>
                </div>
                <div class="form-group">
                    <label for="source_branch">Source Branch:</label>
                    <select name="source_branch" id="source_branch">
                        <option value="main">main</option>
                        {% if branches %}
                        {% for b in branches %}
                        {% if b != 'main' %}
                        <option value="{{ b }}" {% if b == (branch or 'main') %}selected{% endif %}>{{ b }}</option>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create Branch</button>
            </form>
        </details>
    </div>



    <div class="edit-form-container">
        <form id="editForm" action="{{ edit_action }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="branch" value="{{ branch or 'main' }}">
            <div class="form-group">
                <label>Author:</label>
                <input type="text" value="{{ user.username }}" readonly>
                <input type="hidden" name="author" value="{{ user.username }}">
            </div>

            <div class="form-group">
                <label for="content">Content (Visual editor with Markdown save):</label>
                <div class="editor-toolbar" id="wiki-editor-toolbar">
                    <button type="button" data-cmd="formatBlock" data-value="P" class="btn btn-secondary btn-small" title="Normal Text"><i class="fas fa-paragraph"></i> Normal</button>
                    <button type="button" data-cmd="formatBlock" data-value="H1" class="btn btn-secondary btn-small" title="Heading 1"><i class="fas fa-heading"></i> H1</button>
                    <button type="button" data-cmd="formatBlock" data-value="H2" class="btn btn-secondary btn-small" title="Heading 2">H2</button>
                    <button type="button" data-cmd="formatBlock" data-value="H3" class="btn btn-secondary btn-small" title="Heading 3">H3</button>
                    <span class="sep"></span>
                    <button type="button" data-cmd="bold" class="btn btn-secondary btn-small" title="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" data-cmd="italic" class="btn btn-secondary btn-small" title="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" data-cmd="underline" class="btn btn-secondary btn-small" title="Underline"><i class="fas fa-underline"></i></button>
                    <span class="sep"></span>
                    <button type="button" data-cmd="insertUnorderedList" class="btn btn-secondary btn-small" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
                    <button type="button" data-cmd="insertOrderedList" class="btn btn-secondary btn-small" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button type="button" id="createLinkBtn" class="btn btn-secondary btn-small" title="Insert Link"><i class="fas fa-link"></i></button>
                    <span class="sep"></span>
                    <button type="button" id="insertTableBtn" class="btn btn-secondary btn-small" title="Insert Table"><i class="fas fa-table"></i> Table</button>
                    <div class="table-tools">
                        <button type="button" id="addRowBtn" class="btn btn-secondary btn-small" title="Add Row">+ Row</button>
                        <button type="button" id="addColBtn" class="btn btn-secondary btn-small" title="Add Column">+ Col</button>
                        <button type="button" id="delRowBtn" class="btn btn-secondary btn-small" title="Delete Row">- Row</button>
                        <button type="button" id="delColBtn" class="btn btn-secondary btn-small" title="Delete Column">- Col</button>
                    </div>
                    <span class="sep"></span>
                    <button type="button" id="insertImageBtn" class="btn btn-secondary btn-small" title="Insert Image">
                        <i class="fas fa-image"></i> Image
                    </button>
                </div>
                <div id="visual-editor" class="visual-editor" contenteditable="true"></div>
                <textarea id="content" name="content" rows="20" style="display:none;">{{ content }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Page</button>
                <a href="{{ view_path }}?branch={{ branch_value }}" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</a>
            </div>
        </form>
    </div>

    <div class="markdown-help">
        <h3>Markdown Help</h3>
        <ul>
            <li><code># Header</code> - Large header</li>
            <li><code>## Subheader</code> - Smaller header</li>
            <li><code>**bold**</code> - Bold text</li>
            <li><code>*italic*</code> - Italic text</li>
            <li><code>[link](url)</code> - Link To outside resource</li>
            <li><code>[[ Page:Branch ]]</code> - Link to another wiki page</li>
            <li><code>`code`</code> - Inline code</li>
            <li><code>```code block```</code> - Code block</li>
            <li><code>![alt text](image-url)</code> - Image (use Insert Image button to upload)</li>
            <a href="/help/index.html" target="_blank">View global variables</a>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='editor.js') }}"></script>
<script nonce="{{ request.state.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize client-side visual editor (M1 + M2)
        if (window.WikiEditor && typeof window.WikiEditor.init === 'function') {
            window.WikiEditor.init({
                textareaSelector: '#content',
                editorSelector: '#visual-editor',
                toolbarSelector: '#wiki-editor-toolbar',
                formSelector: '#editForm',
                initialMarkdown: document.getElementById('content').value || ''
            });
        }
        // Image upload modal elements
        const modal = document.getElementById('imageUploadModal');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const closeBtn = document.querySelector('.modal .close');
        const cancelUpload = document.getElementById('cancelUpload');
        const imageUploadForm = document.getElementById('imageUploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const contentTextarea = document.getElementById('content');
        
        // Show modal when insert image button is clicked
        insertImageBtn.addEventListener('click', function() {
            modal.style.display = 'block';
        });
        
        // Close modal when close button is clicked
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Close modal when cancel button is clicked
        cancelUpload.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Close modal when clicking outside of modal content
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Handle image upload form submission
        imageUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                uploadStatus.innerHTML = '<div class="alert alert-error">Please select an image file.</div>';
                return;
            }
            
            // Create FormData object
            const formData = new FormData();
            formData.append('file', file);
            // Include CSRF token (kept in body for backward-compat, but we send header too)
            let csrfToken = '';
            try {
                const csrfInput = document.querySelector('input[name="csrf_token"]');
                if (csrfInput && csrfInput.value) {
                    csrfToken = csrfInput.value;
                    formData.append('csrf_token', csrfToken);
                }
            } catch (_) { /* no-op */ }
            
            // Upload image
            uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';
            
            fetch('/upload-image', {
                method: 'POST',
                headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {},
                // Ensure session cookies are sent for auth
                credentials: 'same-origin',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    uploadStatus.innerHTML = '<div class="alert alert-error">' + data.error + '</div>';
                } else {
                    // Insert image into visual editor if available, otherwise into textarea as markdown
                    if (window.WikiEditor && typeof window.WikiEditor.insertImage === 'function') {
                        window.WikiEditor.insertImage({ src: data.url, alt: data.filename });
                    } else {
                        const imageMarkdown = '![' + data.filename + '](' + data.url + ')';
                        const startPos = contentTextarea.selectionStart;
                        const endPos = contentTextarea.selectionEnd;
                        const content = contentTextarea.value;
                        const newContent = content.substring(0, startPos) + imageMarkdown + content.substring(endPos);
                        contentTextarea.value = newContent;
                    }

                    // Close modal
                    modal.style.display = 'none';

                    // Clear form
                    imageUploadForm.reset();
                    uploadStatus.innerHTML = '<div class="alert alert-success">Image uploaded successfully!</div>';
                    
                    // Clear status after 2 seconds
                    setTimeout(() => {
                        uploadStatus.innerHTML = '';
                    }, 2000);
                }
            })
            .catch(error => {
                uploadStatus.innerHTML = '<div class="alert alert-error">Error uploading image: ' + error.message + '</div>';
            });
        });
    });
</script>
{% endblock %}
