{% extends "base.html" %}

{% block title %}History of {{ title }} - {{ config.NAME }}{% endblock %}

{% block content %}
<div class="container">
    {% if error %}
    <div class="alert alert-error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="page-header">
        <h2>History of {{ title }}</h2>
        <div class="page-actions">
            <a href="/page/{{ title }}?branch={{ branch or 'main' }}" class="btn btn-primary"><i class="fas fa-eye"></i> View Page</a>
            <a href="/edit/{{ title }}?branch={{ branch or 'main' }}" class="btn btn-secondary"><i class="fas fa-edit"></i> Edit Page</a>
            <a href="/?branch={{ branch or 'main' }}" class="btn btn-secondary"><i class="fas fa-home"></i> Back to Home</a>
        </div>
    </div>

    {% if branch %}
    <div class="branch-info">
        <p><strong>Current Branch:</strong> {{ branch }}</p>
    </div>
    {% endif %}
    <div class="page-meta">
        <p>
            <strong>Revision History numbers increase with newer versions. Read more <a href="/help/revision_history">here</a>.</strong><br>
            <strong>Total Versions:</strong> {{ versions|length }}
        </p>
    </div>

    {% if versions %}
    {% if versions|length > 1 %}
    <div class="history-compare">
        <form action="/history/{{ title }}/compare" method="get" class="compare-form">
            <input type="hidden" name="branch" value="{{ branch or 'main' }}">
            <div class="compare-select-group">
                {% if compare_defaults %}
                    {% set default_from = compare_defaults['from_index'] %}
                    {% set default_to = compare_defaults['to_index'] %}
                {% else %}
                    {% set default_from = None %}
                    {% set default_to = None %}
                {% endif %}
                <label for="compare-from">Compare</label>
                <select id="compare-from" name="from_version">
                    {% for version in versions %}
                        <option value="{{ version.index }}"
                            {% if default_from is not none and default_from == version.index %}selected{% endif %}>
                            Version {{ version.display_number }} — {{ version.author }} ({{ version.updated_at_display }})
                        </option>
                    {% endfor %}
                </select>
                <span class="compare-separator">to</span>
                <select id="compare-to" name="to_version">
                    {% for version in versions %}
                        <option value="{{ version.index }}"
                            {% if default_to is not none and default_to == version.index %}
                                selected
                            {% elif default_to is none and loop.index0 == 0 %}
                                selected
                            {% endif %}>
                            Version {{ version.display_number }} — {{ version.author }} ({{ version.updated_at_display }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-small btn-secondary"><i class="fas fa-not-equal"></i> Compare</button>
        </form>
    </div>
    {% endif %}

    <div class="history-list">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Author</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for version in versions %}
                <tr>
                    <td>Version {{ version.display_number }}</td>
                    <td>{{ version.author }}</td>
                    <td>{{ version.updated_at_display }}</td>
                    <td>
                        <a href="/history/{{ title }}/{{ version.index }}?branch={{ branch or 'main' }}" class="btn btn-small btn-secondary"><i class="fas fa-eye"></i> View</a>
                        {% if not version.is_current %}
                        <form action="/restore/{{ title }}/{{ version.index }}" method="post" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <input type="hidden" name="branch" value="{{ branch or 'main' }}">
                            <button type="submit" class="btn btn-small btn-warning"
                                    onclick="return confirm('Are you sure you want to restore this version?')"><i class="fas fa-undo"></i> Restore</button>
                        </form>
                        {% else %}
                        <span class="current-version-label">Current version</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No history found for this page.</p>
    {% endif %}
</div>
{% endblock %}
